import{_ as o,c as p,d as l,a as s,e as a,b as t,r as i,o as r}from"./app-lSJJfXGm.js";const d="/assets/1-DxBKD342.png",u="/assets/2-BdMtExsZ.png",c="/assets/3-DNfI5Jos.png",m="/assets/4-DUepaNYx.png",k="/assets/5-Ddo5Prcn.png",b="/assets/6-BIlbhYi2.png",g="/assets/7-x8yvGDYk.png",v="/assets/8-D6TvYY9c.png",I={},f={href:"https://blog.csdn.net/u012894808/article/details/106113865",target:"_blank",rel:"noopener noreferrer"},S={href:"https://www.jianshu.com/p/35bf6f2ba16e",target:"_blank",rel:"noopener noreferrer"},x={href:"https://cloud.tencent.com/developer/article/2285144",target:"_blank",rel:"noopener noreferrer"},M={href:"https://chrisye2015.github.io/2017/08/04/android_systemui_statusbar_systemicons/",target:"_blank",rel:"noopener noreferrer"},y={href:"https://blog.csdn.net/WELL_CODER/article/details/132574091",target:"_blank",rel:"noopener noreferrer"},w={href:"https://blog.csdn.net/wq892373445/article/details/125170985",target:"_blank",rel:"noopener noreferrer"},B={href:"https://blog.csdn.net/decat2008/article/details/109182357",target:"_blank",rel:"noopener noreferrer"},h={href:"https://blog.csdn.net/hfreeman2008/article/details/117963600",target:"_blank",rel:"noopener noreferrer"};function j(U,n){const e=i("ExternalLinkIcon");return r(),p("div",null,[n[39]||(n[39]=l('<h2 id="问题描述" tabindex="-1"><a class="header-anchor" href="#问题描述"><span>问题描述</span></a></h2><p>使用搜狗输入法时，手机顶部状态栏的右侧图标会出现一个搜狗输入法的图标。希望能将其关闭。 <img src="'+d+'" alt="alt text"></p><h2 id="思考方向" tabindex="-1"><a class="header-anchor" href="#思考方向"><span>思考方向</span></a></h2><ul><li>可能是系统单独做了适配，在识别到搜狗输入法启动时在右上角显示图标。</li><li>这个图标也可能是在输入法apk自身存着的，所以可以看看apk的资源文件。</li><li>尝试搜索引擎搜索关键词：安卓状态栏 右侧图标</li></ul><h2 id="探究过程" tabindex="-1"><a class="header-anchor" href="#探究过程"><span>探究过程</span></a></h2><h3 id="系统层面" tabindex="-1"><a class="header-anchor" href="#系统层面"><span>系统层面</span></a></h3>',6)),s("p",null,[n[1]||(n[1]=a("搜到了一个自定义图标的 ")),s("a",f,[n[0]||(n[0]=a("Android状态栏右侧添加图标并控制其显示状态")),t(e)]),n[2]||(n[2]=a("。里面提到了一个xml可以配置图标")),n[3]||(n[3]=s("br",null,null,-1)),n[4]||(n[4]=s("code",null,'在frameworks/base/core/res/res/values/config.xml的string-array name="config_statusBarIcons"中添加我们自己的slot。比如：',-1)),n[5]||(n[5]=s("br",null,null,-1)),n[6]||(n[6]=s("code",null,'<item><xliff:g id="id">@string/status_bar_input_type</xliff:g></item>',-1))]),n[40]||(n[40]=s("p",null,"后续是发送广播和接收广播，但是dex中并没有搜到相关广播和intent。",-1)),n[41]||(n[41]=s("hr",null,null,-1)),s("p",null,[n[8]||(n[8]=a("又搜到了一个文章")),s("a",S,[n[7]||(n[7]=a("Android系统状态栏定制")),t(e)]),n[9]||(n[9]=a("，这里提到了状态栏中图标的分布规则如图，也就是说输入法的图标应该属于系统icon。 ")),n[10]||(n[10]=s("img",{src:u,alt:"alt text"},null,-1))]),n[42]||(n[42]=s("p",null,[a("后续提到了几个java类，"),s("code",null,"StatusBarIconHolder"),a(", "),s("code",null,"Slot"),a(" 等，在dex中还是搜不到。只搜"),s("code",null,"StatusBar"),a("倒是能搜到很多，但都是获取状态栏颜色，高度等，没有设置图标相关。")],-1)),n[43]||(n[43]=s("hr",null,null,-1)),s("p",null,[n[12]||(n[12]=a("又搜到了一个文章")),s("a",x,[n[11]||(n[11]=a("Android IME输入法启动&显示&隐藏流程梳理以及常见问题&调试技巧小结")),t(e)])]),n[44]||(n[44]=l(`<p>太长了，直接搜<code>status</code>，发现了这样一句</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InputMethodManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IInputMethodManager<span class="token punctuation">.</span>Stub</span></span>
<span class="line">        <span class="token keyword">implements</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">,</span> <span class="token class-name">Handler<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">InputMethodManagerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">            <span class="token comment">// 状态栏输入法图标名称, 会根据这个名称设置输入法的图标显示</span></span>
<span class="line">            mSlotIme <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>status_bar_ime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说获取这个id的字符串时，系统会自动向当前正在使用的输入法请求获取其名称？图标是从输入法app中获取，而非存在系统图标库中？（后面研究发现这里应该是我理解错了）</p><hr>`,4)),s("p",null,[n[14]||(n[14]=a("尝试搜索")),n[15]||(n[15]=s("code",null,"com.android.internal.R.string.status_bar_ime",-1)),n[16]||(n[16]=a("相关信息。")),n[17]||(n[17]=s("br",null,null,-1)),n[18]||(n[18]=a(" 搜到一篇文章")),s("a",M,[n[13]||(n[13]=a("Android SystemUI 状态栏——系统状态图标显示与管理")),t(e)]),n[19]||(n[19]=a("，又提到了framework/base/core/res/res/values/config.xml。仔细看了一下，发现确实有status_bar_ime的定义。"))]),n[45]||(n[45]=l('<p><img src="'+c+'" alt="alt text"></p><p>突然想到，之前用AndroidKiller的时候，提到过一个framework.jar的东西，我的理解是这里面存着系统预设的一些样式和图标资源等文件，不如直接找到这个文件，去看一下图标在不在里面。</p><p>打开vmos进入根目录，很轻松发现了/system/framework/目录下有一个41M的apk，名字叫framework-res.apk。打开arsc一瞧，果然<code>status_bar_ime</code>在一个array里面。</p><p><img src="'+m+'" alt="alt text"></p><p>但是再仔细一瞧，array里记录的是资源id的id，下面还有一个string类型的资源id的<code>status_bar_ime</code>，其对应实际字符串就是<code>&quot;ime&quot;</code>三个字母。所以我上面理解的有误，<code>mSlotIme = mContext.getString(com.android.internal.R.string.status_bar_ime);</code> 这个获取到的应该是ime三个字母，然后猜测后续操作是把这个作为key，去一个map中寻找它对应的图标。</p><hr><p>在上面的文章中，发现了一个单词，叫<code>SystemUI</code>。于是换个关键词再继续搜索。</p>',7)),s("p",null,[n[21]||(n[21]=a("发现了这样一篇文章")),s("a",y,[n[20]||(n[20]=a("Android隐藏输入法图标方法——为SystemUI状态栏定制")),t(e)]),n[22]||(n[22]=a("（还有https://blog.csdn.net/baidu_41666295/article/details/126802001）"))]),n[46]||(n[46]=s("p",null,"bing的搜索结果预览看上去非常美好，甚至直接提到了搜狗输入法。",-1)),n[47]||(n[47]=s("p",null,[s("img",{src:k,alt:"alt text"})],-1)),n[48]||(n[48]=s("p",null,"结果点击去csdn告诉我要花60块钱订阅。。。。搜了一下标题和这段预览文字，也没能找到免费版。（吐槽一下csdn，最近越来越多付费文章了，甚至零几年的文章都变成付费，点开作者头像一看好久没发过文章，很是怀疑csdn看哪篇文章浏览量高直接自动变成付费的，就像csdn下载文件一样）",-1)),n[49]||(n[49]=s("hr",null,null,-1)),s("p",null,[n[24]||(n[24]=a("继续翻阅搜索结果，又找到一篇文章")),s("a",w,[n[23]||(n[23]=a("Android 10 SystemUI 如何隐藏状态栏输入法图标")),t(e)]),n[25]||(n[25]=a(" 这篇文章非常简洁明了，做法是修改")),n[26]||(n[26]=s("code",null,"InputMethodManagerService.updateStatusIcon",-1)),n[27]||(n[27]=a("函数。 ")),n[28]||(n[28]=s("code",null,"代码路径： frameworks/base/services/core/java/com/android/server/inputmethod/InputMethodManagerService.java 在InputMethodManagerService.java文件中updateStatusIcon方法中将mStatusBar.setIconVisibility(mSlotIme, true)的true改为false",-1))]),n[50]||(n[50]=s("p",null,"看起来非常简单，但不太符合我的需求，因为用户一般没法自己改这种底层代码然后再自己编译。",-1)),n[51]||(n[51]=s("hr",null,null,-1)),s("p",null,[n[30]||(n[30]=a("根据那篇付费文章启发，搜索引擎搜素关键词直接写上搜狗输入法，这次搜到了一篇文章：")),s("a",B,[n[29]||(n[29]=a("安卓隐藏搜狗输入法右上角图标")),t(e)]),n[31]||(n[31]=a("。"))]),n[52]||(n[52]=l('<p>更加简洁明了，<code>adb shell settings put secure icon_blacklist ime</code> 搞定。看样子是用adb权限修改系统设置，禁用了系统图标中的输入法图标的显示。也就是说以后不管用什么输入法右上角都不会再显示图标了。这个方法还可以。</p><h3 id="应用层面" tabindex="-1"><a class="header-anchor" href="#应用层面"><span>应用层面</span></a></h3><p>问题已经可以解决了，用adb进行全局设置即可。但是有没有别的解决方案呢？既然只有搜狗显示，别的不显示，而且图标也是存在app自身而非系统内，那么这个图标设置一定是在搜狗输入法的代码里完成的。</p><p>定位代码的思路：</p><ol><li>既然是从app传过去的图标，那在apk/res/drawable这种目录下一定能找到图标，然后dex里搜它资源id就行了</li><li>修改系统代码虽然不太可行，但是提供了关键词可以用来搜索：<code>InputMethodManagerService</code></li><li>如果不是在dex中设置，也可能是在manifest中声明，比如在<code>meta-data</code>里记录图标的资源id，然后系统直接从这读取。</li></ol><p>第一种方案尝试了一下就放弃了，因为res下的文件名都是随机字母，还分了无数个子文件夹，这要我找到天荒地老啊（找了一会找到了48x48和60x60的看起来很像的图标，但是dex中没有id调用）。</p><p>第三种方案也搜过了，看了所有带<code>meta-data</code>和<code>status</code>的地方，没有状态栏右上角的那个图标。</p>',7)),s("p",null,[n[33]||(n[33]=a("万般无奈之下只好搜索")),n[34]||(n[34]=s("code",null,"InputMethodManagerService",-1)),n[35]||(n[35]=a("，(这种一看就是系统层的代码，然后对用户隐藏的，sdk中搜不到，所以想要定位函数或者找函数调用啥的很麻烦。)")),n[36]||(n[36]=s("br",null,null,-1)),n[37]||(n[37]=a(" 好在搜到了一篇文章: ")),s("a",h,[n[32]||(n[32]=a("android开发浅谈之InputMethodManagerService")),t(e)]),n[38]||(n[38]=a("。"))]),n[53]||(n[53]=l('<p><img src="'+b+'" alt="alt text"></p><p>我们自己实现输入法，需要继承<code>InputMethodService</code>类，然后<code>InputMethodManager</code>在sdk中也是可见的，只有<code>InputMethodManagerService</code>不可见。</p><p>先整理一下思路。</p><ul><li>直接改<code>InputMethodManagerService.updateStatusIcon</code>做不到，但是可以做到不调用<code>updateStatusIcon</code>，或者保留调用这个函数但是尝试往里传一个不存在的资源id。因此就要寻找都有哪些地方调用了<code>updateStatusIcon</code>这个函数。</li><li>由于这个函数所在类在sdk中找不到，所以想要查找函数调用很不方便。</li></ul><p>现在需要解决的问题就是：如何查找<code>updateStatusIcon</code>的函数调用。根据上面的图可以发现，这三个类都是紧密相连的，也就是说互相之间都有沟通，那么就可以去另外两个可见类中，搜索是否有对<code>updateStatusIcon</code>的调用。</p><p>去<code>InputMethodManager</code>里搜索<code>updateStatusIcon</code>，还真出现了，在<code>InputMethodManager.showStatusIcon</code>函数中，根据名字一眼就能明白，调用此函数后，状态栏右侧就会显示输入法图标。但是这个函数被注明废弃，说应该用<code>InputMethodService.showStatusIcon(int)</code>。</p><p>不管哪个都好，直接去dex里搜<code>showStatusIcon</code>，发现只有一处调用</p><p><img src="'+g+'" alt="alt text"></p><p>注释掉之后，发现果然状态栏不再显示输入法的系统图标了。左图修改前，右图修改后：</p><p><img src="'+v+`" alt="alt text"></p><p>当然，修改apk带来的代价就是：每次启动都会有个Toast：你使用的是盗版应用。不确定后续使用中是否还有其他副作用。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><ul><li>SystemUI：负责系统UI绘制，例如状态栏（顶端），导航栏（底端），通知栏（状态栏下拉）等等。</li><li>输入法图标所在的位置，对应的是状态栏右侧的系统图标区域，与左侧的应用通知图标稍有不同。</li><li>可以在应用中调用<code>InputMethodService.show/hideStatusBar(int)</code>，来显示/隐藏输入法对应的系统图标，也可以使用<code>adb shell settings put secure icon_blacklist ime</code>借助adb禁用输入法系统图标。</li><li>上面贴的文章中，有一些还介绍了输入法的adb调试相关，例如<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 列出所有输入法服务</span></span>
<span class="line">adb shell ime list <span class="token parameter variable">-a</span> <span class="token parameter variable">-s</span></span>
<span class="line"><span class="token comment"># 可以获取到输入法的各种信息, 并且可以过滤window信息</span></span>
<span class="line">adb shell dumpsys input_method <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> window</span>
<span class="line"><span class="token comment"># 获取输入法的窗口状态信息</span></span>
<span class="line">adb shell dumpsys window <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> input</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul>`,13))])}const C=o(I,[["render",j],["__file","index.html.vue"]]),D=JSON.parse('{"path":"/blogs/2024/spring/androidSystenUISystemIconStatusBarIME/","title":"安卓状态栏 系统图标 隐藏输入法(搜狗)图标","lang":"zh-CN","frontmatter":{"date":"2024-3-4 14:04:28","title":"安卓状态栏 系统图标 隐藏输入法(搜狗)图标","categories":["android"],"tags":["android","ime","statusBar","systemUI"]},"headers":[{"level":2,"title":"问题描述","slug":"问题描述","link":"#问题描述","children":[]},{"level":2,"title":"思考方向","slug":"思考方向","link":"#思考方向","children":[]},{"level":2,"title":"探究过程","slug":"探究过程","link":"#探究过程","children":[{"level":3,"title":"系统层面","slug":"系统层面","link":"#系统层面","children":[]},{"level":3,"title":"应用层面","slug":"应用层面","link":"#应用层面","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1709552891000,"updatedTime":1711092212000,"contributors":[{"name":"ewt45","email":"79033456+ewt45@users.noreply.github.com","commits":2}]},"filePathRelative":"blogs/2024/spring/androidSystenUISystemIconStatusBarIME/index.md"}');export{C as comp,D as data};
