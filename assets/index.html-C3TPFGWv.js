import{_ as e,c as l,a as s,d as o,e as a,b as p,r as u,o as i}from"./app-lSJJfXGm.js";const c={},r={href:"https://github.com/brunodev85/winlator/tree/main/audio_plugin",target:"_blank",rel:"noopener noreferrer"},d={href:"https://archlinux.org/packages/extra/x86_64/alsa-plugins/files/",target:"_blank",rel:"noopener noreferrer"};function k(q,n){const t=u("ExternalLinkIcon");return i(),l("div",null,[n[12]||(n[12]=s("h2",{id:"前言",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#前言"},[s("span",null,"前言")])],-1)),n[13]||(n[13]=s("p",null,"winlator自己实现了一个alsa的插件，在容器设置中，将dx组件 - directSound和directMusic改为native（windows）后，播放音频不会出现爆音。",-1)),s("p",null,[n[1]||(n[1]=a("在winlator的github页面，提供了")),s("a",r,[n[0]||(n[0]=a("alsa插件的源码以及编译脚本")),p(t)]),n[2]||(n[2]=a("：。尝试将其移植到exagear中，以尝试解决exa的alsa插件爆音问题。"))]),n[14]||(n[14]=s("h2",{id:"从winlator移植到exagear",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#从winlator移植到exagear"},[s("span",null,"从winlator移植到exagear")])],-1)),n[15]||(n[15]=s("h3",{id:"分析",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#分析"},[s("span",null,"分析")])],-1)),s("ul",null,[n[10]||(n[10]=s("li",null,[a("java代码中，需要有alsa声音播放相关的代码。exa中为"),s("code",null,"com.eltechs.axs.alsaServer"),a("包，winlator中为"),s("code",null,"com.winlator.alsaserver"),a("包。由于winlator java代码大幅度借鉴exa，所以很方便移植。")],-1)),s("li",null,[n[4]||(n[4]=a("winlator在github上提供的代码仅为linux端的alsa插件，编译出的名字是")),n[5]||(n[5]=s("code",null,"libasound_module_pcm_android_aserver.so",-1)),n[6]||(n[6]=a("。在wlt数据包中搜索，发现该文件位于")),n[7]||(n[7]=s("code",null,"/usr/lib/${arch}linux-gnu/alsa-lib",-1)),n[8]||(n[8]=a("中，其中arch是架构名称。搜索exa的数据包发现也有alsa-lib目录，且其中还有很多其他的so，网络搜索发现是")),s("a",d,[n[3]||(n[3]=a("通过alsa-plugins安装")),p(t)]),n[9]||(n[9]=a("的。"))]),n[11]||(n[11]=o("<li>安卓声音与linux声音需要以某种方式关联起来。观察代码了解到，是建立了socket连接。socket文件，exa中为<code>String.format(&quot;%s%d&quot;, SocketPaths.ALSA_SERVER, Integer.valueOf(this.productId)</code>，仅以ed301为例，是<code>&quot;/tmp/.sound/AS12&quot;</code>，而winlator是<code>&quot;/tmp/.sound/AS0&quot;</code>。winlator alsa插件中（c代码）接收该路径的方式是通过环境变量。exa也有设置此环境变量，但二者变量名略有不同，exa为<code>AXS_SOUND_SERVER_PORT</code>，winlator为<code>ANDROID_ALSA_SERVER</code></li><li>winlator中如果想要解决爆音，必不可少的一步就是将dx组件的声音dll设置为native(windows)。</li><li>github页还提供了两个conf，在wlt的数据包中搜索可确定其放置位置。<code>android_aserver.conf</code> 放在<code>/etc/alsa/conf.d</code>，其内容中的type是编译的so文件名后半部分。<code>alsa.conf</code> 放在 <code>/usr/share/alsa</code> ,其内容是记录<code>android_aserver.conf</code>的路径。具体编写格式尚未了解。</li>",3))]),n[16]||(n[16]=o(`<div class="custom-container tip"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">TIP</p><p>下文需要的文件，可以从此链接中下载：https://wwqv.lanzout.com/b013gl1yh 密码:9gbq</p></div><h3 id="修改apk" tabindex="-1"><a class="header-anchor" href="#修改apk"><span>修改apk</span></a></h3><p>需要修改apk的dex。</p><ul><li><p>直接替换</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">com.eltechs.axs.alsaServer.*</span>
<span class="line">com.eltechs.axs.environmentService.components.ALSAServerComponent</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>下载smali.zip并解压，覆盖原有的smali</p></li><li><p>手动修改</p><p><code>com.eltechs.axs.configuration.UBTLaunchConfiguration.smali</code>中，<code>addArgumentsToEnvironment()</code>方法中，字符串 <code>&quot;AXS_SOUND_SERVER_PORT=%s&quot;</code> 改为 <code>&quot;ANDROID_ALSA_SERVER=%s&quot;</code></p></li></ul><h3 id="修改obb" tabindex="-1"><a class="header-anchor" href="#修改obb"><span>修改obb</span></a></h3><p>所谓数据包其实就是rootfs，下文均对解压后的数据包，即z盘进行操作。</p><ul><li>alsa相关：下载winlator-alsa-plugin.zip，解压其中内容到z盘，覆盖同名文件夹。</li><li>注册表：打开winecfg - libraries 找到dsound dmusic 等dll，点击编辑，选择native(windows)；若没有则需要在上方空白处手动输入并添加，再编辑。完整的dll列表可以参考<code>winlator.apk/assets/dxcomponents.json</code>。directsound和directmusic肯定是声音相关的，show和play不确定。</li></ul><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;direct3d&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;d3dcompiler_33&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_34&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_35&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_36&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_37&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_38&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_39&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_40&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_41&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_42&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_43&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_46&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcompiler_47&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcsx_42&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dcsx_43&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_33&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_34&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_35&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_36&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_37&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_38&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_39&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_40&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_41&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_42&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx10_43&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx11_42&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx11_43&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_24&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_25&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_26&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_27&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_28&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_29&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_30&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_31&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_32&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_33&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_34&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_35&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_36&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_37&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_38&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_39&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_40&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_41&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_42&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d3dx9_43&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;directsound&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dsound&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;directmusic&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dmband&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmcompos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmloader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmscript&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmstyle&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmsynth&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmusic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dmusic32&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dswave&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;directshow&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;amstream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qasf&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qcap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qdvd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qedit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;quartz&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;directplay&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dplaysvr.exe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dplayx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dpmodemx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dpnet&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dpnhpast&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dpnhupnp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dpnsvr.exe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dpwsockx&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="测试结果" tabindex="-1"><a class="header-anchor" href="#测试结果"><span>测试结果</span></a></h2><ul><li>测试游戏-镜之边缘，wine7.0.2</li></ul><p>先将system32中的dsound.dll设置为纯净wineprefix中的dll（也就是builtin的dll？）。</p><ul><li>winlator alsa，dll为native,builtin时，和exa一样爆音，视频声音正常。dll为native时，不爆音，但无法播放视频声音等。</li><li>pulseaudio，dll为native,builtin时，不爆音 ，视频声音正常。dll为native时，不爆音，缺少视频声音。</li><li>exagear alsa，dll为native,built时，爆音，视频声音正常，dll为native时没有任何声音，但dsound换为302k后native无爆音且可播放视频声音。 但这几种winecfg里测试音频都没声。</li><li>根据老虎山所说，winlator比exa的优势在于没有大叔音，爆音基本相同。</li><li>关于native和builtin的说明：https://www.hu60.cn/q.php/bbs.topic.103014.html</li></ul>`,12))])}const x=e(c,[["render",k],["__file","index.html.vue"]]),m=JSON.parse('{"path":"/blogs/2023/summer/winlatorAlsa/","title":"在exagear中使用winlator的alsa插件","lang":"zh-CN","frontmatter":{"date":"2023-8-27 16:55:22","title":"在exagear中使用winlator的alsa插件","categories":["exagear"],"tags":["exagear","winlator","alsa-plugins"]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"从winlator移植到exagear","slug":"从winlator移植到exagear","link":"#从winlator移植到exagear","children":[{"level":3,"title":"分析","slug":"分析","link":"#分析","children":[]},{"level":3,"title":"修改apk","slug":"修改apk","link":"#修改apk","children":[]},{"level":3,"title":"修改obb","slug":"修改obb","link":"#修改obb","children":[]}]},{"level":2,"title":"测试结果","slug":"测试结果","link":"#测试结果","children":[]}],"git":{"createdTime":1693140801000,"updatedTime":1693210550000,"contributors":[{"name":"ewt45","email":"79033456+ewt45@users.noreply.github.com","commits":2}]},"filePathRelative":"blogs/2023/summer/winlatorAlsa/index.md"}');export{x as comp,m as data};
