import{_ as c,c as u,a,d as i,b as e,f as l,e as s,r as o,o as r}from"./app-lSJJfXGm.js";const d="/assets/2-CpZPXVUF.gif",k={},m={class:"table-of-contents"},g={href:"https://4pda.to/forum/index.php?showtopic=992239&st=1360#entry98298500",target:"_blank",rel:"noopener noreferrer"},v={href:"https://www.bilibili.com/video/BV1P24y1D7fY/",target:"_blank",rel:"noopener noreferrer"},x={href:"https://developer.android.google.cn/training/data-storage?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"},f={href:"https://wiki.winehq.org/Wine_User%27s_Guide#Drive_Settings",target:"_blank",rel:"noopener noreferrer"};function b(h,n){const t=o("router-link"),p=o("ExternalLinkIcon");return r(),u("div",null,[a("nav",m,[a("ul",null,[a("li",null,[e(t,{to:"#前言"},{default:l(()=>n[0]||(n[0]=[s("前言")])),_:1})]),a("li",null,[e(t,{to:"#演示视频"},{default:l(()=>n[1]||(n[1]=[s("演示视频：")])),_:1})]),a("li",null,[e(t,{to:"#将此功能添加到apk"},{default:l(()=>n[2]||(n[2]=[s("将此功能添加到apk")])),_:1})]),a("li",null,[e(t,{to:"#探索过程"},{default:l(()=>n[3]||(n[3]=[s("探索过程")])),_:1}),a("ul",null,[a("li",null,[e(t,{to:"#获取文件路径"},{default:l(()=>n[4]||(n[4]=[s("获取文件路径")])),_:1})]),a("li",null,[e(t,{to:"#文本框"},{default:l(()=>n[5]||(n[5]=[s("文本框")])),_:1})]),a("li",null,[e(t,{to:"#检查可用性"},{default:l(()=>n[6]||(n[6]=[s("检查可用性")])),_:1})]),a("li",null,[e(t,{to:"#关闭对话框修改偏好"},{default:l(()=>n[7]||(n[7]=[s("关闭对话框修改偏好")])),_:1})]),a("li",null,[e(t,{to:"#wine修改d盘路径的方法"},{default:l(()=>n[8]||(n[8]=[s("wine修改d盘路径的方法")])),_:1})]),a("li",null,[e(t,{to:"#测试结果"},{default:l(()=>n[9]||(n[9]=[s("测试结果")])),_:1})])])]),a("li",null,[e(t,{to:"#总结"},{default:l(()=>n[10]||(n[10]=[s("总结")])),_:1})])])]),n[22]||(n[22]=a("h2",{id:"前言",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#前言"},[a("span",null,"前言")])],-1)),a("p",null,[n[12]||(n[12]=s("允许用户手动指定wine的d盘对应安卓文件路径的位置。 获取sd卡方法参照了hugo的apk。最早能找到的出处应该是这个")),n[13]||(n[13]=a("s",null,"https://www.youtube.com/watch?v=QLD7tqMWK9s",-1)),n[14]||(n[14]=s(" 应该是")),a("a",g,[n[11]||(n[11]=s("gfoxsh")),e(p)])]),n[23]||(n[23]=a("p",null,[s("其实在写代码的过程中发现了这个Exagear自带的Action类"),a("code",null,"CreatePutYourApplicationsHereDirectory"),s("，不过没看见调用的地方。也没细研究了。")],-1)),n[24]||(n[24]=a("p",null,[a("img",{src:d,alt:"图1"})],-1)),n[25]||(n[25]=a("h2",{id:"演示视频",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#演示视频"},[a("span",null,"演示视频：")])],-1)),a("p",null,[a("a",v,[n[15]||(n[15]=s("【Exagear】可手动切换d盘路径的功能")),e(p)])]),n[26]||(n[26]=i('<h2 id="将此功能添加到apk" tabindex="-1"><a class="header-anchor" href="#将此功能添加到apk"><span>将此功能添加到apk</span></a></h2><p>见<a href="/blogs/2022/winter/exagearFab#%E5%B0%86%E6%AD%A4%E5%8A%9F%E8%83%BD%E6%B7%BB%E5%8A%A0%E5%88%B0apk">为exagear添加一个悬浮操作按钮</a>的对应章节</p><h2 id="探索过程" tabindex="-1"><a class="header-anchor" href="#探索过程"><span>探索过程</span></a></h2><p>本节为自用，主要记录实现java代码的过程。</p><h3 id="获取文件路径" tabindex="-1"><a class="header-anchor" href="#获取文件路径"><span>获取文件路径</span></a></h3>',5)),a("p",null,[a("a",x,[n[16]||(n[16]=s("官网关于存储空间的简易说明")),e(p)])]),n[27]||(n[27]=i(`<ol><li><p>一般路径分这三种：</p><ul><li>外部存储 <ul><li>路径：<code>/storage/emulated/0</code></li><li>说明：exagear默认会从这个路径找Download文件夹或ExaGear文件夹。</li><li>获取：<code>Environment.getExternalStorageDirectory();</code></li></ul></li><li>外部存储的应用专属目录 <ul><li>路径：<code>/storage/emulated/0/Android/data/包名/files</code></li><li>说明：安卓11及以上，游戏在非应用专属目录下加载速度奇慢。解决方法是将游戏复制到应用专属目录（c/z盘），或将d盘路径直接设置为应用专属目录。</li><li>获取：<code>Globals.getAppContext().getExternalFilesDir(null);</code></li></ul></li><li>外置SD卡的应用专属目录 <ul><li>路径：<code>/???/Android/data/包名/files</code>。前面的？？？不固定，可能的格式有：/storage/数字字母，/storage/sdcard1 , mnt/ext_sdcard 等</li><li>说明：在高版本安卓上，获取外置SD卡的非应用专属目录读写权限可能没那么容易，所以不搞=-=。</li><li>获取：<code>Globals.getAppContext().getExternalFilesDirs(null)[1];</code>。<strong>从大神那抄来的，没想到啊，还能这么获取。</strong></li></ul></li></ul><p><strong>应用专属目录，在应用卸载时会一同被删除。</strong></p></li><li><p>大小写敏感：</p><p>极少部分情况是大小写敏感的。比如默认读取的是ExaGear文件夹，写成了exagear会不识别。</p><p>顺带一提，在CreateTypicalWineLaunchConfiguration类中发现了一段代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileHelpers</span><span class="token punctuation">.</span><span class="token function">checkCaseInsensitivityInDirectory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>exagearRootFromPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    uBTLaunchConfiguration<span class="token punctuation">.</span><span class="token function">addEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;EXADROID_FS_CASE_INSENSITIVE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过checkCaseInsensitivityInDirectory始终返回的是false =-=</p></li><li><p>浏览文件夹：</p><p>本来是想写个功能，设置好路径之后点击按钮跳转到文件管理器查看这个文件夹。但是</p><ul><li><code>file://</code>：这个uri的前缀被废弃了，所以高版本安卓没法用。</li><li><code>content://</code>：这个高版本安卓可以用但是要用FileProvider，修改manifest和xml，麻烦。</li></ul><p>放弃。</p></li></ol><h3 id="文本框" tabindex="-1"><a class="header-anchor" href="#文本框"><span>文本框</span></a></h3><p>原本用的是最基础的textview+edittext放到一个LinearLayout里，后来发现一个官方的material组件库。改成了TextInputLayout和TextInputEditText。</p><ol><li><p>组件样式参考：</p><ul><li>https://github.com/material-components/material-components-android/tree/master/docs/components</li><li>https://www.jianshu.com/p/533b397c63f0</li><li>https://www.digitalocean.com/community/tutorials/android-textinputlayout-example</li></ul><p>设置标题的话，给内部的edittext设置hint就行。不需要手动写textview+edittext再放到LinearLayout里了。</p></li><li><p>自动填充建议：</p><p>需求为：用户点击edittext输入框后，弹出几个预设的选项，用户点击预设选项后editext被自动填入数据。</p><p>尝试了AutoCompleteText，发现需要手动输入至少一个字母才能弹出来，不符合需求。而Material组件库里虽然官方给了一个示例是只选择不能手动输入的，但那个要最新的库+样式，ex没自带就算了。</p><p>所以用的还是PopupMenu。禁用调起输入法的方法为<code>edittext.setInputType(InputType.TYPE_NULL);</code></p></li><li><p>文件夹路径和文件夹名称</p><p>一共两个edittext，一个父路径，只能选择不能手动输入，另一个文件夹名，可以选择可以手写。二者内容更新时都应调用checkCurrDirAvailable函数检查更新路径的可用性。</p><ul><li>父路径在popupmenu点击item之后更新成员变量currentParDir（int），edittext文字显示和检查可用性。</li><li>文件夹名在addTextChangedListener中更新成员变量currentDstDirName（String）并检查可用性。</li></ul></li><li><p>存在的bug</p><p>原本自己的项目测试的挺好的，结果搬到ex中，clearFocus的时候也会获取focus，导致popupMenu一直弹出来。</p><p>后来把自己项目最小sdk和目标sdk与ex同步了，发现自己项目也会出现这个问题，只好取消掉clearFocus的代码，并且从普通EditText换成TextInputEditText。</p></li></ol><h3 id="检查可用性" tabindex="-1"><a class="header-anchor" href="#检查可用性"><span>检查可用性</span></a></h3><p>在用户修改路径后应该检查可用性，一开始是设置一个按钮点击检查，后来去掉了按钮，改成实时检查。应当在edittext有任何变化时都调用checkCurrDirAvailable。</p><ol><li><p>判断文件夹是否存在且可读写</p><p>可用性检查内容：</p><ul><li>若两个父路径无法获取，或文件夹没填写，显示“无法获取路径”</li><li>否则正常获取文件夹，然后检查文件夹五个权限，参考https://blog.csdn.net/zfking86/article/details/7995532，用位运算记录一下五个函数的结果，然后显示到textview上。如果符合条件就加对号，否则加错号。</li></ul></li><li><p>设置检查结果颜色</p><p>在textview中使用span https://developer.android.com/develop/ui/views/text-and-emoji/spans#appearance-spans textview.settext，传参数是spannableString，构造的时候用SpannableStringBuilder，和普通stringbuilder一样。</p><p>需要设置某个字符颜色的时候,<code>str.setSpan(new ForegroundColorSpan(0xffF56C6C),str.length()-1,str.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</code> EXCLUSIVE_EXCLUSIVE意思大概是不管是往这个位置插入字符，还是结尾又添加新字符，都不会将颜色设置到新插入的文字上。</p><p>对号显示绿色，错号显示红色，如果检查到某个是错号了，那么往下一定是错号，不显示错号该显示删除线<code>new StyleSpan(Typeface.BOLD)</code></p></li></ol><h3 id="关闭对话框修改偏好" tabindex="-1"><a class="header-anchor" href="#关闭对话框修改偏好"><span>关闭对话框修改偏好</span></a></h3><ol><li><p>修改偏好</p><p>fragment实现接口DialogInterface.OnClickListener，当which==BUTTON_POSITIVE且设置的路径可用，则写入偏好。</p><p>整个dialog应该只有在点击确定按钮并关闭的时候才会向sharedPreference中写入数据</p></li><li><p>提示消息 用SnackBar，在底部弹出。带action。 需要附着到一个view上，snackbar会自动从这个view往上找到根布局附着上，由于dialog马上就要关了，所以不能设置到dialog的view。应该设置fab按钮的那个view，也就是fab初始化时添加到的那个父view。所以调用一下fab中的静态方法。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Snackbar</span><span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token class-name">FabMenu</span><span class="token punctuation">.</span><span class="token function">getMainFrameView</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AppCompatActivity</span><span class="token punctuation">)</span> <span class="token function">requireActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token class-name">E<span class="token punctuation">.</span>DriveD_SncBrTxt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Snackbar</span><span class="token punctuation">.</span><span class="token constant">LENGTH_LONG</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">S</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token class-name">E<span class="token punctuation">.</span>DriveD_SncBrBtn</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">-&gt;</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Process</span><span class="token punctuation">.</span><span class="token function">killProcess</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Process</span><span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="wine修改d盘路径的方法" tabindex="-1"><a class="header-anchor" href="#wine修改d盘路径的方法"><span>wine修改d盘路径的方法</span></a></h3><p>添加自己的代码，把mUserAreaDir初始化时改为调用自己的函数获取路径。</p><p>不过这还没完，因为修改dex后，把d盘路径从Exagear改为Download，发现只有新创建的容器的路径是改变的。</p><p>d盘在Exagear的老容器，看<code>/home/xdroid/.wine/dosdevices</code>中，发现<code>d:</code>符号链接指向路径没变，而且还有一个文件叫<code>d_</code>，也不是符号链接，打开发现是个文本，里面写了Exagear的路径。<br> 查看z盘，发现Download已经挂载上了，于是打开winecfg手动设置一下，发现这两个d的文件都变成Download的了。</p>`,13)),a("p",null,[n[18]||(n[18]=s("去winehq官网查了一下")),a("a",f,[n[17]||(n[17]=s("驱动器的说明")),e(p)]),n[19]||(n[19]=s("，得知想切换驱动器路径，只需要改符号链接即可，并不需要其他特别的操作。")),n[20]||(n[20]=a("br",null,null,-1)),n[21]||(n[21]=s(" 手头又没linux，搞了个在线版linux手动操作了一下符号链接，才发现问题原因：把A被作为B的符号链接后，如果想把A作为C的符号链接，则需要先清除A当前的符号链接，不清除直接设置的话A的符号链接还是B的不会变。dex中就是没有清除原有符号链接。"))]),n[28]||(n[28]=i(`<p>由于每次启动的时候Exagear都会把对应容器的xdroid_n链接到xdroid，这个是没问题的，就看了一下这部分的代码，结果发现是直接获取xdroid的file调用<code>file.delete()</code>了。问了老虎山大佬，安卓上删符号链接文件是不会影响真文件的，所以那就放心大胆的删吧 ^ ^</p><p>CreateLaunchConfiguration中是建立cdez盘符号链接的。在建立d盘符号链接之前先delete()一下 224行</p><div class="language-smali line-numbers-mode" data-highlighter="prismjs" data-ext="smali" data-title="smali"><pre><code><span class="line">    invoke-direct <span class="token punctuation">{</span><span class="token register variable">v3</span><span class="token punctuation">,</span> <span class="token register variable">v4</span><span class="token punctuation">,</span> <span class="token register variable">v5</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>io<span class="token punctuation">/</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token operator">-&gt;</span><span class="token function">&lt;init&gt;</span><span class="token punctuation">(</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>io<span class="token punctuation">/</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>lang<span class="token punctuation">/</span></span><span class="token class-name">String</span></span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token builtin">V</span></span>
<span class="line">    <span class="token comment">#这里删除文件吧，不知道安不安全</span></span>
<span class="line">    invoke-virtual <span class="token punctuation">{</span><span class="token register variable">v3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>io<span class="token punctuation">/</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token operator">-&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">Z</span></span>
<span class="line"></span>
<span class="line">    invoke-virtual <span class="token punctuation">{</span><span class="token register variable">v3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>io<span class="token punctuation">/</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token operator">-&gt;</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>lang<span class="token punctuation">/</span></span><span class="token class-name">String</span></span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试了一下，是不会删除真目录的。</p><h3 id="测试结果" tabindex="-1"><a class="header-anchor" href="#测试结果"><span>测试结果</span></a></h3><ul><li>设置路径后重启app，即可正常切换。</li><li>原先的路径还会链接到镜像根目录下，不过不删也无所谓吧</li><li>手机没有sd卡插槽，没法测试sd卡，在虚拟机上测试是可以获取目录的读取权限。用的方法是别人的，应该不会有问题。</li></ul><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><ul><li>wine切换盘符的路径其实就是更换软链接。这么一看甚至没必要改安卓dex了=-=算了反正有用户友好提示也不错</li><li>TextInputLayout挺不错的，自带标题，也可以加edittext</li><li>写完这篇博客才想起来去找一下获取sd卡方法的出处，看到vividotg视频标题还有个获取u盘的方法，结果看视频是sd卡和u盘同时存在，读的是sd卡，sd卡弹出就读u盘。猜测那个方法获取到的数组，第二个元素往后都是连接的外部存储设备，只不过懒得再测试了。。。</li><li>将wine中的磁盘与安卓文件夹关联起来，首先需要创建一个安卓文件夹到z盘（应用专属目录）下的符号链接，然后再创建一个该符号链接到wine磁盘的符号链接。 <ul><li>前者通过PrepareGuestImage类中，调用exagearImageConfigurationHelpers.createVpathsList，传入安卓文件夹路径实现。通过这个操作，可以将对应文件夹挂载到z盘根目录（貌似只能到根目录）</li><li>后者通过CreateLaunchConfiguration类中，SafeFileHelpers.symlink创建z盘中对应挂载的文件夹到wine的盘符的符号链接</li></ul></li></ul>`,8))])}const E=c(k,[["render",b],["__file","driveD.html.vue"]]),D=JSON.parse('{"path":"/blogs/2022/winter/exagearFab/driveD.html","title":"为exagear添加选择d盘路径功能","lang":"zh-CN","frontmatter":{"date":"2022-12-13 18:52:37","title":"为exagear添加选择d盘路径功能","categories":["exagear"],"tags":["wine","TextInputEditText"]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"演示视频：","slug":"演示视频","link":"#演示视频","children":[]},{"level":2,"title":"将此功能添加到apk","slug":"将此功能添加到apk","link":"#将此功能添加到apk","children":[]},{"level":2,"title":"探索过程","slug":"探索过程","link":"#探索过程","children":[{"level":3,"title":"获取文件路径","slug":"获取文件路径","link":"#获取文件路径","children":[]},{"level":3,"title":"文本框","slug":"文本框","link":"#文本框","children":[]},{"level":3,"title":"检查可用性","slug":"检查可用性","link":"#检查可用性","children":[]},{"level":3,"title":"关闭对话框修改偏好","slug":"关闭对话框修改偏好","link":"#关闭对话框修改偏好","children":[]},{"level":3,"title":"wine修改d盘路径的方法","slug":"wine修改d盘路径的方法","link":"#wine修改d盘路径的方法","children":[]},{"level":3,"title":"测试结果","slug":"测试结果","link":"#测试结果","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1670991768000,"updatedTime":1679131850000,"contributors":[{"name":"ewt45","email":"79033456+ewt45@users.noreply.github.com","commits":4}]},"filePathRelative":"blogs/2022/winter/exagearFab/driveD.md"}');export{E as comp,D as data};
