<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>完善Exagear XServer的X11核心协议, 解决wine8.6和wine5.0+ staging无法在ex的xserver上使用的问题 | 博客</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-BnPP2NeH.css" as="style"><link rel="stylesheet" href="/assets/style-BnPP2NeH.css">
    <link rel="modulepreload" href="/assets/app-lSJJfXGm.js"><link rel="modulepreload" href="/assets/index.html-Dgv5WEvh.js">
    <link rel="prefetch" href="/assets/timeline.html-BAvVtoBI.js" as="script"><link rel="prefetch" href="/assets/posts.html-BDe9RmJC.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-5V_0ldeR.js" as="script"><link rel="prefetch" href="/assets/1.html-yy2yFytV.js" as="script"><link rel="prefetch" href="/assets/1.html-nTxjU1Bc.js" as="script"><link rel="prefetch" href="/assets/2.html-DZ-3w1VZ.js" as="script"><link rel="prefetch" href="/assets/3.html-DZ3bEvhb.js" as="script"><link rel="prefetch" href="/assets/1.html-ZRhaUqLX.js" as="script"><link rel="prefetch" href="/assets/1.html-Dw8_-m24.js" as="script"><link rel="prefetch" href="/assets/1.html-D2p--ZRn.js" as="script"><link rel="prefetch" href="/assets/1.html-BKcCMUG3.js" as="script"><link rel="prefetch" href="/assets/1.html-C6pQh-RC.js" as="script"><link rel="prefetch" href="/assets/1.html-CYKCRyI3.js" as="script"><link rel="prefetch" href="/assets/2.html-DJbJUUuj.js" as="script"><link rel="prefetch" href="/assets/1.html-B6B-juSh.js" as="script"><link rel="prefetch" href="/assets/1.html-v9pKxjgF.js" as="script"><link rel="prefetch" href="/assets/1.html-De7IlD7i.js" as="script"><link rel="prefetch" href="/assets/1.html-CHE8FBaR.js" as="script"><link rel="prefetch" href="/assets/1.html-RqMXOz5Q.js" as="script"><link rel="prefetch" href="/assets/1.html-Dof7uOmY.js" as="script"><link rel="prefetch" href="/assets/1.html-C5tNz7tA.js" as="script"><link rel="prefetch" href="/assets/1.html-CNMa2M-d.js" as="script"><link rel="prefetch" href="/assets/1.html-BoJFA7la.js" as="script"><link rel="prefetch" href="/assets/1.html-DK6IPxzw.js" as="script"><link rel="prefetch" href="/assets/1.html-BXhANdLw.js" as="script"><link rel="prefetch" href="/assets/1.html-BmUrsBLW.js" as="script"><link rel="prefetch" href="/assets/1.html-DNaqT86r.js" as="script"><link rel="prefetch" href="/assets/1.html-Dl0GJ-jH.js" as="script"><link rel="prefetch" href="/assets/1.html-yCcpQztl.js" as="script"><link rel="prefetch" href="/assets/1.html-DBv1IOaq.js" as="script"><link rel="prefetch" href="/assets/1.html-C0Zwxfqb.js" as="script"><link rel="prefetch" href="/assets/1.html-iVIhowxE.js" as="script"><link rel="prefetch" href="/assets/1.html-Bcnqkk_9.js" as="script"><link rel="prefetch" href="/assets/1.html-CYVqutMM.js" as="script"><link rel="prefetch" href="/assets/1.html-SDgp3aOs.js" as="script"><link rel="prefetch" href="/assets/1.html-B38hZpmE.js" as="script"><link rel="prefetch" href="/assets/1.html-C9q0qIEw.js" as="script"><link rel="prefetch" href="/assets/1.html-Bg9Js69h.js" as="script"><link rel="prefetch" href="/assets/2.html-eRtQpz5X.js" as="script"><link rel="prefetch" href="/assets/1.html-Dv_I2idE.js" as="script"><link rel="prefetch" href="/assets/1.html-Dn6C90gc.js" as="script"><link rel="prefetch" href="/assets/1.html-y1hVWCcl.js" as="script"><link rel="prefetch" href="/assets/1.html-BSQiaV1J.js" as="script"><link rel="prefetch" href="/assets/1.html-DXi2vSUl.js" as="script"><link rel="prefetch" href="/assets/1.html-Jgq6TbQK.js" as="script"><link rel="prefetch" href="/assets/1.html-CURNMHjC.js" as="script"><link rel="prefetch" href="/assets/1.html-CUfabN0R.js" as="script"><link rel="prefetch" href="/assets/1.html-ChhkJBFb.js" as="script"><link rel="prefetch" href="/assets/1.html-y8Il0XMP.js" as="script"><link rel="prefetch" href="/assets/1.html-CXBcIIjb.js" as="script"><link rel="prefetch" href="/assets/1.html-DEYIk8-q.js" as="script"><link rel="prefetch" href="/assets/1.html-CUB-76jf.js" as="script"><link rel="prefetch" href="/assets/1.html-BR-vtOCm.js" as="script"><link rel="prefetch" href="/assets/1.html-Di6IvUbD.js" as="script"><link rel="prefetch" href="/assets/1.html-iKeLMEA1.js" as="script"><link rel="prefetch" href="/assets/1.html-B23WFga2.js" as="script"><link rel="prefetch" href="/assets/1.html-DBAywDxx.js" as="script"><link rel="prefetch" href="/assets/1.html-C7gBBOTt.js" as="script"><link rel="prefetch" href="/assets/1.html-DtTuhNez.js" as="script"><link rel="prefetch" href="/assets/1.html-CjbxeMTY.js" as="script"><link rel="prefetch" href="/assets/1.html-VedXetm4.js" as="script"><link rel="prefetch" href="/assets/1.html-C7vkUq9U.js" as="script"><link rel="prefetch" href="/assets/1.html-CKoDS6cD.js" as="script"><link rel="prefetch" href="/assets/1.html-D2AjppoH.js" as="script"><link rel="prefetch" href="/assets/1.html-D6uas5Q5.js" as="script"><link rel="prefetch" href="/assets/1.html-DZaxw3Vt.js" as="script"><link rel="prefetch" href="/assets/1.html-Ciw9aOQK.js" as="script"><link rel="prefetch" href="/assets/2.html-Czvu1qhK.js" as="script"><link rel="prefetch" href="/assets/1.html-BL1u0BXg.js" as="script"><link rel="prefetch" href="/assets/1.html-DOrS_H42.js" as="script"><link rel="prefetch" href="/assets/1.html-D_-YFshT.js" as="script"><link rel="prefetch" href="/assets/1.html-C7oQNTeb.js" as="script"><link rel="prefetch" href="/assets/1.html-D6q7O-YE.js" as="script"><link rel="prefetch" href="/assets/1.html-BKtgxFao.js" as="script"><link rel="prefetch" href="/assets/1.html-ChHfA7Ub.js" as="script"><link rel="prefetch" href="/assets/1.html-BYmHK36B.js" as="script"><link rel="prefetch" href="/assets/1.html-kA591iPl.js" as="script"><link rel="prefetch" href="/assets/1.html-B6Z9JHUx.js" as="script"><link rel="prefetch" href="/assets/1.html-DeW5UuLV.js" as="script"><link rel="prefetch" href="/assets/1.html-Ly1Izu-z.js" as="script"><link rel="prefetch" href="/assets/1.html-D0dXHV11.js" as="script"><link rel="prefetch" href="/assets/1.html-CZ6hGlzj.js" as="script"><link rel="prefetch" href="/assets/1.html-CSl7qz7_.js" as="script"><link rel="prefetch" href="/assets/1.html-hoorisB2.js" as="script"><link rel="prefetch" href="/assets/1.html-DfMmJBkA.js" as="script"><link rel="prefetch" href="/assets/1.html-CvjQlPb-.js" as="script"><link rel="prefetch" href="/assets/1.html-mMwmaqNv.js" as="script"><link rel="prefetch" href="/assets/1.html-BbZEnfuL.js" as="script"><link rel="prefetch" href="/assets/1.html-DMy9vnUO.js" as="script"><link rel="prefetch" href="/assets/1.html-CaB-TTNA.js" as="script"><link rel="prefetch" href="/assets/1.html-DTTqmB1M.js" as="script"><link rel="prefetch" href="/assets/1.html-DG0Ri2-3.js" as="script"><link rel="prefetch" href="/assets/1.html-CbdOtFX6.js" as="script"><link rel="prefetch" href="/assets/1.html-BPggE-vd.js" as="script"><link rel="prefetch" href="/assets/1.html-HSH3YtDr.js" as="script"><link rel="prefetch" href="/assets/1.html-CblnYoQH.js" as="script"><link rel="prefetch" href="/assets/1.html-DW3jzJmF.js" as="script"><link rel="prefetch" href="/assets/1.html-EbscoznH.js" as="script"><link rel="prefetch" href="/assets/1.html-BVzHmXLV.js" as="script"><link rel="prefetch" href="/assets/1.html-ks4RjumV.js" as="script"><link rel="prefetch" href="/assets/1.html-BH1KfGMl.js" as="script"><link rel="prefetch" href="/assets/1.html-zPiztlwQ.js" as="script"><link rel="prefetch" href="/assets/1.html-DbQUkwnm.js" as="script"><link rel="prefetch" href="/assets/1.html-lC7lLhGV.js" as="script"><link rel="prefetch" href="/assets/1.html-CLYr7dtL.js" as="script"><link rel="prefetch" href="/assets/1.html-ojawvUMc.js" as="script"><link rel="prefetch" href="/assets/1.html-BZEAgw8b.js" as="script"><link rel="prefetch" href="/assets/1.html-DYCe7dPb.js" as="script"><link rel="prefetch" href="/assets/1.html-DTn0dGU2.js" as="script"><link rel="prefetch" href="/assets/1.html--B2a8o7V.js" as="script"><link rel="prefetch" href="/assets/1.html-7Ua1aPJo.js" as="script"><link rel="prefetch" href="/assets/1.html-Gj4i9rQj.js" as="script"><link rel="prefetch" href="/assets/1.html-BoZMEBVy.js" as="script"><link rel="prefetch" href="/assets/1.html-XU3T-WYT.js" as="script"><link rel="prefetch" href="/assets/1.html-D1V-fulj.js" as="script"><link rel="prefetch" href="/assets/1.html-pymXCC7r.js" as="script"><link rel="prefetch" href="/assets/2.html-Ubr6swgl.js" as="script"><link rel="prefetch" href="/assets/3.html-CjLKwczA.js" as="script"><link rel="prefetch" href="/assets/4.html-CZDmeODS.js" as="script"><link rel="prefetch" href="/assets/5.html-CvM0EXix.js" as="script"><link rel="prefetch" href="/assets/index.html-BBKCb86C.js" as="script"><link rel="prefetch" href="/assets/index.html-Cy-Y6qO0.js" as="script"><link rel="prefetch" href="/assets/index.html--IG5pKEw.js" as="script"><link rel="prefetch" href="/assets/index.html-D_zAtQ3A.js" as="script"><link rel="prefetch" href="/assets/index.html-QY7s6tas.js" as="script"><link rel="prefetch" href="/assets/index.html-DDwaHnCa.js" as="script"><link rel="prefetch" href="/assets/index.html-DgszJxPY.js" as="script"><link rel="prefetch" href="/assets/deprecated.html-CRMXFzvC.js" as="script"><link rel="prefetch" href="/assets/index.html-Rc_VX8bK.js" as="script"><link rel="prefetch" href="/assets/index_EN.html-ByFpT8Si.js" as="script"><link rel="prefetch" href="/assets/index.html-BuF_ye6e.js" as="script"><link rel="prefetch" href="/assets/index.html-DWAaArns.js" as="script"><link rel="prefetch" href="/assets/index.html-CqZrKvZ4.js" as="script"><link rel="prefetch" href="/assets/index.html-BdQrDGCb.js" as="script"><link rel="prefetch" href="/assets/index.html-DfEreS3A.js" as="script"><link rel="prefetch" href="/assets/index.html-xfauZgFa.js" as="script"><link rel="prefetch" href="/assets/index.html-CPq8pEd4.js" as="script"><link rel="prefetch" href="/assets/index.html-QR87e8Ls.js" as="script"><link rel="prefetch" href="/assets/detailed.html-CYf3qOPR.js" as="script"><link rel="prefetch" href="/assets/index.html-CQq5mgbv.js" as="script"><link rel="prefetch" href="/assets/index.html-BMQ4-iAy.js" as="script"><link rel="prefetch" href="/assets/index.html-B679GBm9.js" as="script"><link rel="prefetch" href="/assets/index.html-CCrvZbLJ.js" as="script"><link rel="prefetch" href="/assets/driveD.html-CcD-EJvX.js" as="script"><link rel="prefetch" href="/assets/index.html-BQuueml5.js" as="script"><link rel="prefetch" href="/assets/index.html-gEKDxyu6.js" as="script"><link rel="prefetch" href="/assets/index.html-Bhz11Ob5.js" as="script"><link rel="prefetch" href="/assets/index.html-BkeY5tbW.js" as="script"><link rel="prefetch" href="/assets/index.html-Bvnzpb-9.js" as="script"><link rel="prefetch" href="/assets/index.html-DCAyTCDU.js" as="script"><link rel="prefetch" href="/assets/index.html-DD-LFEVB.js" as="script"><link rel="prefetch" href="/assets/index.html-DkAhnggS.js" as="script"><link rel="prefetch" href="/assets/index.html-DFxQCUU9.js" as="script"><link rel="prefetch" href="/assets/index.html-9VL9SfQK.js" as="script"><link rel="prefetch" href="/assets/index.html-BlTTay7L.js" as="script"><link rel="prefetch" href="/assets/index.html-t5GXM772.js" as="script"><link rel="prefetch" href="/assets/index.html-CSlhuypt.js" as="script"><link rel="prefetch" href="/assets/index.html-C5jNpAm8.js" as="script"><link rel="prefetch" href="/assets/index.html-DjJMF_aD.js" as="script"><link rel="prefetch" href="/assets/index.html-DBOL5oAg.js" as="script"><link rel="prefetch" href="/assets/index.html-CyMED2UU.js" as="script"><link rel="prefetch" href="/assets/index.html-Brt8k1u9.js" as="script"><link rel="prefetch" href="/assets/index.html-DTKB9h7D.js" as="script"><link rel="prefetch" href="/assets/index_en.html-BXYBFagB.js" as="script"><link rel="prefetch" href="/assets/index.html-C3TPFGWv.js" as="script"><link rel="prefetch" href="/assets/index.html-BEi31oBx.js" as="script"><link rel="prefetch" href="/assets/index.html-DQMJgohn.js" as="script"><link rel="prefetch" href="/assets/index.html-oa6BlAsi.js" as="script"><link rel="prefetch" href="/assets/index.html-C22QzVzY.js" as="script"><link rel="prefetch" href="/assets/index.html-DoJ7ZtnH.js" as="script"><link rel="prefetch" href="/assets/index.html-BGBq_6tl.js" as="script"><link rel="prefetch" href="/assets/index.html-De0w7Z4M.js" as="script"><link rel="prefetch" href="/assets/index.html-DPCBOMd7.js" as="script"><link rel="prefetch" href="/assets/404.html-BfWx50pL.js" as="script"><link rel="prefetch" href="/assets/Valine.min-Bnm5pcBZ.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-DWEKOTfS.js" as="script"><link rel="prefetch" href="/assets/PokopeaMain-MDrkiEMa.js" as="script"><link rel="prefetch" href="/assets/example-CYQHARbw.js" as="script"><link rel="prefetch" href="/assets/main-BTkXXdD8.js" as="script"><link rel="prefetch" href="/assets/ActionBili-Czh0m-6-.js" as="script"><link rel="prefetch" href="/assets/ActionDialog-CVwUbXiR.js" as="script"><link rel="prefetch" href="/assets/ActionInfo-B23WMb5r.js" as="script"><link rel="prefetch" href="/assets/ActionSub-Pfdqagrq.js" as="script"><link rel="prefetch" href="/assets/ActionYt-CrnOPkTb.js" as="script"><link rel="prefetch" href="/assets/IconBili-CMtoYxHz.js" as="script"><link rel="prefetch" href="/assets/IconInfo-D1wXkJcd.js" as="script"><link rel="prefetch" href="/assets/IconSub-D5TM9A67.js" as="script"><link rel="prefetch" href="/assets/IconYt-D_vP9lhp.js" as="script"><link rel="prefetch" href="/assets/ToolDarkMode-9w8ghlWD.js" as="script"><link rel="prefetch" href="/assets/ToolFilter-B32drc-T.js" as="script"><link rel="prefetch" href="/assets/ToolInfoLink-DOCFQvn0.js" as="script"><link rel="prefetch" href="/assets/ToolMenus-yA0GO2Nj.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-DfZWbE-_.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><!----><a href="/" class="site-name">博客</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="首页"><!--[--><!--]--><span class="xicon-container left"><!--[--><IconHome class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"></IconHome><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->首页<!--]--></span></span><!--[--><!--]--></a></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">完善Exagear XServer的X11核心协议, 解决wine8.6和wine5.0+ staging无法在ex的xserver上使用的问题</h1><div class="page-info"><!----><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2023-4-20 10:35:24<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/categories/exagear/1.html" class="">exagear</a><a href="/categories/jishu/1.html" class="">技术</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/tags/XServer/1.html" class="">XServer</a><a href="/tags/exagear/1.html" class="">exagear</a><a href="/tags/Core-X11-Protocol/1.html" class="">Core X11 Protocol</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><nav class="table-of-contents"><ul><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#前言" class="router-link-active router-link-exact-active">前言</a></li><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#将已写好的补充函数添加到apk" class="router-link-active router-link-exact-active">将已写好的补充函数添加到apk</a></li><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#探索过程" class="router-link-active router-link-exact-active">探索过程</a><ul><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#处理函数的函数层注解" class="router-link-active router-link-exact-active">处理函数的函数层注解</a></li><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#处理函数的参数层注解" class="router-link-active router-link-exact-active">处理函数的参数层注解</a></li><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#处理函数的返回值" class="router-link-active router-link-exact-active">处理函数的返回值</a></li><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#自己编写处理函数" class="router-link-active router-link-exact-active">自己编写处理函数</a></li></ul></li><li><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#总结" class="router-link-active router-link-exact-active">总结</a></li></ul></nav><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>wine更新了8.6（目前只有Kron4ek的编译版本，不知道为啥官网没更新）。使用ex的xserver打开后，直接闪退了，并在x86-stderr.txt中出现了如下报错。Wine staging5.0以上也会出现类似报错。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">X Error of failed request:  BadRequest (invalid request code or no such operation)</span>
<span class="line">  Major opcode of failed request:  49 (X_ListFonts)</span>
<span class="line">  Serial number of failed request:  6</span>
<span class="line">  Current serial number in output stream:  6</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>观察ex的dex，发现在<code>Opcodes</code>类中定义了ListFonts常量恰好为49，而且同包名（<code>com.eltechs.axs.requestHandlers.core</code>）下，有很多类，里面的方法带着注解<code>@RequestHandler(opcode = 数字)</code>，也就是对应opcode的函数实现。</p><p>查阅资料，发现这个是X11的核心协议的一部分，看来是exagear没有实现全，那么就要手动添加上了。</p><ul><li><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html" target="_blank" rel="noopener noreferrer">官方对于xlib的说明及完整列表<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://cgit.freedesktop.org/xorg/proto/xproto/tree/Xproto.h" target="_blank" rel="noopener noreferrer">接收的参数信息和返回的参数信息<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.x.org/wiki/Development/Documentation/Protocol/OpCodes/" target="_blank" rel="noopener noreferrer">有关opcode的说明<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="将已写好的补充函数添加到apk" tabindex="-1"><a class="header-anchor" href="#将已写好的补充函数添加到apk"><span>将已写好的补充函数添加到apk</span></a></h2><p>使用MT管理器等工具编辑dex，添加压缩包中的smali，如果有重名则覆盖。<br><a href="https://wwqv.lanzout.com/iyFyv0thllti" target="_blank" rel="noopener noreferrer">点击下载文件<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="探索过程" tabindex="-1"><a class="header-anchor" href="#探索过程"><span>探索过程</span></a></h2><p>本节为自用，主要记录实现java代码的过程。</p><p>有关资料，可以在前言中寻找。</p><h3 id="处理函数的函数层注解" tabindex="-1"><a class="header-anchor" href="#处理函数的函数层注解"><span>处理函数的函数层注解</span></a></h3><p>在前言中提到了注解，一个完整的函数长这样</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestHandler</span><span class="token punctuation">(</span>opcode <span class="token operator">=</span> <span class="token number">45</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">OpenFont</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ParamName</span><span class="token punctuation">(</span><span class="token string">&quot;nameLength&quot;</span><span class="token punctuation">)</span> <span class="token keyword">short</span> s<span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">short</span> s2<span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@ParamLength</span><span class="token punctuation">(</span><span class="token string">&quot;nameLength&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;cursor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notImplementedYet</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;OpenFont supports only font=&#39;cursor&#39;, but got &#39;%s&#39;.&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>@ReuqestHandler作用在函数上，表明该函数对应的opcode。之前想尝试解决鼠标偏移的时候误打误撞研究过这里，发现原来是可以通过注解 在RootXRequestHandlerConfigurer类中配置这些函数。 相关代码如下。可以看到，先获取对象的全部方法，然后尝试获取方法的注解，如果有RequestHandler注解，则将此方法添加到数组中。之后就可以随时从数组中获取。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configureDispatcher</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> objArr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> obj <span class="token operator">:</span> objArr<span class="token punctuation">)</span> </span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span>
<span class="line">            <span class="token class-name">RequestHandler</span> requestHandler <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RequestHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> </span>
<span class="line">                <span class="token function">processOneHandler</span><span class="token punctuation">(</span>requestHandler<span class="token punctuation">.</span><span class="token function">opcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">installRequestHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">OpcodeHandler</span> opcodeHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opcodeHandlers<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">OpcodeHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> opcodeHandlerArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpcodeHandler</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opcodeHandlers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> opcodeHandlerArr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opcodeHandlers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>opcodeHandlers <span class="token operator">=</span> opcodeHandlerArr<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opcodeHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;A handler for the opcode %d is already registered.&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>opcodeHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> opcodeHandler<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="处理函数的参数层注解" tabindex="-1"><a class="header-anchor" href="#处理函数的参数层注解"><span>处理函数的参数层注解</span></a></h3><p>然后ex的xserver应该是用socket通信，所以接收到Request的时候，会拿到一个字节数组。在AnnotationDrivenOpcodeHandler类中，通过method.invoke调用对应的处理方法。主要内容如下。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span> <span class="token comment">// com.eltechs.axs.proto.input.OpcodeHandler</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token class-name">XClient</span> xClient<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">byte</span> minorOpCode<span class="token punctuation">,</span> <span class="token class-name">XRequest</span> xRequest<span class="token punctuation">,</span> <span class="token class-name">XResponse</span> xResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">XProtocolError</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">LocksManager<span class="token punctuation">.</span>XLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xServer<span class="token punctuation">.</span><span class="token function">getLocksManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>locks<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlerObject<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestParser<span class="token punctuation">.</span><span class="token function">getRequestHandlerParameters</span><span class="token punctuation">(</span>xClient<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xServer<span class="token punctuation">,</span> xRequest<span class="token punctuation">,</span> xResponse<span class="token punctuation">,</span> length<span class="token punctuation">,</span> minorOpCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        lock<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中XClient，XResponse如果在处理方法中声明为参数就传进去，没有就不传。然后获取处理方法参数的注解，如果该参数带<code>@RequestParam</code>，就从字节数组中读取一些字节作为该参数的值。如果全部处理完带该注解的参数，字节数组还有剩余，则会抛出异常，所以要确定好参数的个数和类型。</p><p>有关处理方法的参数注解，<code>@ParamName(&quot;nameLength&quot;)</code>和<code>@ParamLength(&quot;nameLength&quot;)</code>组合使用，可以读取指定长度的字符作为字符串，如下示例。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@RequestParam @ParamName(&quot;nameLength&quot;) short s,</span>
<span class="line">@ParamLength(&quot;nameLength&quot;) @RequestParam String str</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>还有一个<code>@ParamWidth(数字)</code>,数字只能是1或2或4，用于读取指定长度的字节作为一个基础类型的参数值。</p><h3 id="处理函数的返回值" tabindex="-1"><a class="header-anchor" href="#处理函数的返回值"><span>处理函数的返回值</span></a></h3><p>在参考规范中，可以看到很多处理函数都是带返回值的，但是ex中的函数没有直接return返回，而是通过XResponse类，写入socket来返回值。</p><p>再看两个简单的例子</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestHandler</span><span class="token punctuation">(</span>opcode <span class="token operator">=</span> <span class="token class-name">GetPointerControl</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">GetPointerControl</span><span class="token punctuation">(</span><span class="token class-name">XResponse</span> xResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    xResponse<span class="token punctuation">.</span><span class="token function">sendSimpleSuccessReply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XResponse<span class="token punctuation">.</span>ResponseDataWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// from class: com.eltechs.axs.requestHandlers.core.PointerRelatedRequests.2</span></span>
<span class="line">        <span class="token annotation punctuation">@Override</span> <span class="token comment">// com.eltechs.axs.xconnectors.BufferFiller</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> byteBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Locks</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;INPUT_DEVICES&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@RequestHandler</span><span class="token punctuation">(</span>opcode <span class="token operator">=</span> <span class="token number">44</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">QueryKeymap</span><span class="token punctuation">(</span><span class="token class-name">XResponse</span> xResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    xResponse<span class="token punctuation">.</span><span class="token function">sendSimpleSuccessReply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我没仔细研究过写入格式是啥，反正大概就是将返回值写入字节数组。</p><p>注意如果该处理函数需要有返回值，而没调用xResponse发送一个socket的话，那么请求方就会一直等着。测试发现，比如在初始化时有一个返回值没返回，ex就会卡在启动环境后的加载中那个界面。</p><h3 id="自己编写处理函数" tabindex="-1"><a class="header-anchor" href="#自己编写处理函数"><span>自己编写处理函数</span></a></h3><p>对于wine8.6 缺的是ListFonts。添加函数：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestHandler</span><span class="token punctuation">(</span>opcode <span class="token operator">=</span> <span class="token number">49</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ListFonts</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">XClient</span> xClient<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">XResponse</span> xResponse <span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@Unsigned</span> <span class="token annotation punctuation">@Width</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">int</span> maxNames<span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ParamName</span><span class="token punctuation">(</span><span class="token string">&quot;patternLength&quot;</span><span class="token punctuation">)</span> <span class="token keyword">short</span> length<span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@ParamLength</span><span class="token punctuation">(</span><span class="token string">&quot;patternLength&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> pattern</span>
<span class="line">        <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;TAG&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;看看要求的pattern是啥？&quot;</span><span class="token operator">+</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fontLists <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    xResponse<span class="token punctuation">.</span><span class="token function">sendSimpleSuccessReply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XResponse<span class="token punctuation">.</span>ResponseDataWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// from class: com.eltechs.axs.requestHandlers.core.AtomManipulationRequests.1</span></span>
<span class="line">        <span class="token annotation punctuation">@Override</span> <span class="token comment">// com.eltechs.axs.xconnectors.BufferFiller</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> byteBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于wine5.0以上staging，缺的是GetPointerMapping。添加函数</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestHandler</span><span class="token punctuation">(</span>opcode <span class="token operator">=</span> <span class="token class-name">GetPointerMapping</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">GetPointerMapping</span><span class="token punctuation">(</span><span class="token class-name">XResponse</span> xResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    xResponse<span class="token punctuation">.</span><span class="token function">sendSimpleSuccessReply</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">new</span> <span class="token class-name">XResponse<span class="token punctuation">.</span>ResponseDataWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token annotation punctuation">@Override</span></span>
<span class="line">                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> byteBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    byteBuffer<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要说一点，如果写的处理函数参数格式不正确，是会直接报错的，再加上我现在ex的dex基本反编译完了，这块调试很方便，所以可以确定参数是没问题的。<br><s>但是返回值没有研究过传哪去了，也不知道怎么调试，所以不敢保证自己写的函数返回值正确。从结果来看，添加函数之后不会报错，不会闪退，可以正常进入环境。</s> 写这篇博客的时候搜了一下，找到返回值结构了。。。</p><h4 id="分析请求参数" tabindex="-1"><a class="header-anchor" href="#分析请求参数"><span>分析请求参数</span></a></h4><p>如果想查看request传入的字节数组具体内容的话，可以在<code>RootXRequestHandler.handleNormalRequest()</code>打log。数组最开头两位分别是majorOpcode和minorOpcode。拿个ListFonts传入的字节数组为例 <code>[49, 0, 4, 0, 1, 0, 5, 0, 102, 105, 120, 101, 100, 0, 0, 0]</code></p><p>在<code>https://cgit.freedesktop.org/xorg/proto/xproto/tree/Xproto.h</code>中查找，可找到ListFonts的请求数据格式和返回数据格式。（在写这篇博客之前，也就是写函数的时候我还不知道在这里能查数据格式orz）</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">//请求数据格式</span></span>
<span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    CARD8 reqType<span class="token punctuation">;</span></span>
<span class="line">    BYTE pad<span class="token punctuation">;</span></span>
<span class="line">    CARD16 length B16<span class="token punctuation">;</span></span>
<span class="line">    CARD16 maxNames B16<span class="token punctuation">;</span></span>
<span class="line">    CARD16 nbytes B16<span class="token punctuation">;</span>  <span class="token comment">/* followed immediately by string bytes */</span></span>
<span class="line"><span class="token punctuation">}</span> xListFontsReq<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//返回数据格式</span></span>
<span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    BYTE type<span class="token punctuation">;</span>  <span class="token comment">/* X_Reply */</span></span>
<span class="line">    BYTE pad1<span class="token punctuation">;</span></span>
<span class="line">    CARD16 sequenceNumber B16<span class="token punctuation">;</span></span>
<span class="line">    CARD32 length B32<span class="token punctuation">;</span></span>
<span class="line">    CARD16 nFonts B16<span class="token punctuation">;</span></span>
<span class="line">    CARD16 pad2 B16<span class="token punctuation">;</span></span>
<span class="line">    CARD32 pad3 B32<span class="token punctuation">;</span></span>
<span class="line">    CARD32 pad4 B32<span class="token punctuation">;</span></span>
<span class="line">    CARD32 pad5 B32<span class="token punctuation">;</span></span>
<span class="line">    CARD32 pad6 B32<span class="token punctuation">;</span></span>
<span class="line">    CARD32 pad7 B32<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> xListFontsReply<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html#XListFonts" target="_blank" rel="noopener noreferrer">Xlib页面<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>的函数介绍</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">char **XListFonts(Display *display, char *pattern, int maxnames, int *actual_count_return);</span>
<span class="line"></span>
<span class="line">display         Specifies the connection to the X server.</span>
<span class="line">pattern         Specifies the null-terminated pattern string that can contain wildcard characters.</span>
<span class="line">maxnames        Specifies the maximum number of names to be returned.</span>
<span class="line">actual_count_return     Returns the actual number of font names.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看字节数组，49是majorcode，0是minorcode，接下来的4跟剩余字节个数有关，设它为n</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">int n = 4;</span>
<span class="line">int i = (n != 0) ? 4 : 8;</span>
<span class="line">int remaning = (n * 4) - i;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>算出remaning=12，正好是剩下的字节个数。所以这个4大概对应结构体中的<code>length</code>？在往下，小端序读取两个字节 = 01，对应结构体中的<code>maxNames</code>，即最多可返回的字符串个数。再读两个字节 = 05，对应结构体的<code>nbytes</code>，即应往下读取五个字节作为接下来的字符串参数<code>pattern</code>，手动将ascii转字符，可得字符串为<code>fixed</code>。完毕。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><ul><li>exgear自制的xserver，在<code>com.eltechs.axs.requestHandlers</code>包下实现了大部分的X11核心协议，和一小部分伪装的扩展协议，用于处理request，但是并不全。</li><li>处理协议的函数，接收和发送数据都是利用socket，也就是需要从接收字节转为参数，再把返回值转为字节发送。通过在函数头加上注解@RequestHandler，将处理函数与对应的Xlib操作关联起来。</li><li>某些没有实现的核心协议，如果用到了会抛出严重异常，xserver会直接关闭，扩展协议的话基础使用可以不用到，但是3d渲染很多都会需要，所以exagear里用3d渲染挺麻烦的，尤其是硬件渲染。</li><li>补齐处理函数，可以先在x86-stderr.txt中查一下majorcode和函数名，然后在Xlib界面查找对应的函数介绍（https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html ），根据请求和返回数据格式（ https://cgit.freedesktop.org/xorg/proto/xproto/tree/Xproto.h ）编写函数，通过@RequestParam注明要接收的参数，通过xResponse将返回值写入字节数组中。</li></ul></div></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Last Updated 4/20/2023, 6:02:50 AM<!--]--></span></span></div></footer><!----><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#前言" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="前言"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->前言<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#将已写好的补充函数添加到apk" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="将已写好的补充函数添加到apk"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->将已写好的补充函数添加到apk<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#探索过程" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="探索过程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->探索过程<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#处理函数的函数层注解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="处理函数的函数层注解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->处理函数的函数层注解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#处理函数的参数层注解" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="处理函数的参数层注解"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->处理函数的参数层注解<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#处理函数的返回值" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="处理函数的返回值"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->处理函数的返回值<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#自己编写处理函数" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="自己编写处理函数"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->自己编写处理函数<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/2023/spring/exagearX11CoreProtocol/#总结" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-lSJJfXGm.js" defer></script>
  </body>
</html>
